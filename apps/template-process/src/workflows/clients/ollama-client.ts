import { HttpService } from '@nestjs/axios';
import { Injectable } from '@nestjs/common';
import { lastValueFrom } from 'rxjs';

const llamaMock =
  '"{\n  \"chave_acesso_nfse\": null,\n  \"numero_nfse\": \"4\",\n  \"competencia_nfse\": \"01/07/2024\",\n  \"data_hora_emissao_nfse\": \"01/07/202414:59:32\",\n  \"numero_dps\": \"13\",\n  \"serie_dps\": \"900\",\n  \"data_hora_emissao_dps\": \"01/07/202414:59:32\",\n  \"emitente_nfse_prestador_servico_cnpj_cpf_nif\": \"49.514.570/0001-99\",\n  \"emitente_nfse_inscricao_municipal\": \"-\",\n  \"emitente_nfse_telefone\": \"(21)0000-0000\",\n  \"emitente_nfse_nome_nome_empresarial\": \"49.514.570REBECAPESSOAFERREIRAFERNANDES\",\n  \"emitente_nfse_email\": \"REBECAPFFERNANDES@GMAIL.COM\",\n  \"emitente_nfse_endereco_logradouro\": \"FELIPECARDOSO- DE1055AOFIM-LADOIMPAR,1985,SANTACRUZ\",\n  \"emitente_nfse_endereco_numero\": null,\n  \"emitente_nfse_endereco_bairro\": null,\n  \"emitente_nfse_municipio\": \"RiodeJaneiro-RJ\",\n  \"emitente_nfse_cep\": \"23520-571\",\n  \"emitente_nfse_simples_nacional_data_competencia\": \"Optante-MicroempreendedorIndividual(MEI)\",\n  \"emitente_nfse_regime_apuracao_tributaria_sn\": \"-\",\n  \"tomador_servico_cnpj_cpf_nif\": \"28.776.766/0001-81\",\n  \"tomador_servico_inscricao_municipal\": \"-\",\n  \"tomador_servico_telefone\": \"-\",\n  \"tomador_servico_nome_nome_empresarial\": \"CL2MPROJETOSEMEDUCACAOS.A.\",\n  \"tomador_servico_email\": \"liviatoledo@pontue.com.br\",\n  \"tomador_servico_endereco_logradouro\": \"RUIBARBOSA,156,ANDAR1 SALA6,BELAVISTA\",\n  \"tomador_servico_endereco_numero\": null,\n  \"tomador_servico_endereco_andar\": \"Andar1 Sala6\",\n  \"tomador_servico_endereco_sala\": \"Sala6\",\n  \"tomador_servico_endereco_bairro\": null,\n  \"tomador_servico_municipio\": \"S\\u00e3oPaulo-SP\",\n  \"tomador_servico_cep\": \"01326-010\",\n  \"intermediario_servico_identificado_nfse\": \"-\",\n  \"servico_prestado_codigo_tributacao_nacional\": \"08.02.01-Instrução,treinamento,orientaçãopedagógicae educacion...\",\n  \"servico_prestado_codigo_tributacao_municipal\": \"-\",\n  \"servico_prestado_local_prestacao\": \"RiodeJaneiro-RJ\",\n  \"servico_prestado_pais_prestacao\": null,\n  \"servico_prestado_descricao_servico\": \"Correçãoderedação.\",\n  \"tributacao_municipal_tributacao_issqn_operacao_tributavel\": \"-\",\n  \"tributacao_municipal_pais_resultado_prestacao_servico\": null,\n  \"tributacao_municipal_municipio_incidencia_issqn\": \"RiodeJaneiro-RJ\",\n  \"tributacao_municipal_regime_especial_tributacao\": \"Nenhum\",\n  \"tributacao_municipal_tipo_imunidade\": \"-\",\n  \"tributacao_municipal_suspensao_exigibilidade_issqn\": \"Não\",\n  \"tributacao_municipal_numero_processo_suspensao\": null,\n  \"tributacao_municipal_beneficio_municipal\": \"-\",\n  \"tributacao_municipal_valor_servico\": \"R$894,00\",\n  \"tributacao_municipal_desconto_incondicionado\": \"-\",\n  \"tributacao_municipal_total_deducoes_reducoes\": null,\n  \"tributacao_municipal_calculo_bm\": null,\n  \"tributacao_municipal_bc_issqn\": null,\n  \"tributacao_municipal_alotacao_aplicada\": null,\n  \"tributacao_municipal_retencoes_issqn\": \"-\",\n  \"tributacao_municipal_issqn_apurado\": null,\n  \"tributacao_federal_irrf\": \"R$0,00\",\n  \"tributacao_federal_cp\": \"R$0,00\",\n  \"tributacao_federal_csll\": \"R$0,00\",\n  \"tributacao_federal_pis\": \"-\",\n  \"tributacao_federal_cofins\": \"-\",\n  \"tributacao_federal_retencoes_pis_cofins\": null,\n  \"tributacao_federal_total_tributos_federais\": null,\n  \"valor_total_nfse_valor_servico\": \"R$894,00\",\n  \"valor_total_nfse_desconto_condicionado\": \"-\",\n  \"valor_total_nfse_desconto_incondicionado\": \"-\",\n  \"valor_total_nfse_issqn_retido\": \"-\",\n  \"valor_total_nfse_irrf_cp_csll_retidos\": null,\n  \"valor_total_nfse_pis_cofins_retidos\": null,\n  \"valor_total_nfse_valor_liquido_nfse\": \"R$894,00\",\n  \"totas_aproximados_tributos_federais\": \"-\",\n  \"totas_aproximados_tributos_estaduais\": \"-\",\n  \"totas_aproximados_tributos_municipais\": \"-\"\n}"';

const qwenMock =
  '{\n\"chave_acesso_nfse\": \"33045572249514570000199000000000000424077905465036\",\n\"numero_nfse\": \"4\",\n\"competencia_nfse\": \"01/07/2024\",\n\"data_hora_emissao_nfse\": \"01/07/2024 14:59:32\",\n\"numero_dps\": \"13\",\n\"serie_dps\": \"900\",\n\"data_hora_emissao_dps\": \"01/07/2024 14:59:32\",\n\"emitente_nfse_prestador_servico_cnpj_cpf_nif\": \"49.514.570/0001-99\",\n\"emitente_nfse_inscricao_municipal\": \"-\",\n\"emitente_nfse_telefone\": \"(21)0000-0000\",\n\"emitente_nfse_nome_nome_empresarial\": \"49.514.570 REBECA PESSOA AFREIRE LAFERNANDES\",\n\"emitente_nfse_email\": \"rebecapffernandes@gmail.com\",\n\"emitente_nfse_endereco_logradouro\": \"FELIPECARDOSO- DE 1055A OFIM - LADO IMPAR, 1985, SANTACRUZ\",\n\"emitente_nfse_endereco_numero\": \"\",\n\"emitente_nfse_endereco_bairro\": \"-\",\n\"emitente_nfse_municipio\": \"RiodeJaneiro- RJ\",\n\"emitente_nfse_cep\": \"23520-571\",\n\"emitente_nfse_simples_nacional_data_competencia\": \"Optante - Microempreendedor Individual (MEI)\",\n\"emitente_nfse_regime_apuracao_tributaria_sn\": \"-\",\n\"tomador_servico_cnpj_cpf_nif\": \"28.776.766/0001-81\",\n\"tomador_servico_inscricao_municipal\": \"-\",\n\"tomador_servico_telefone\": \"-\",\n\"tomador_servico_nome_nome_empresarial\": \"CL2MPROJETOS E MEDUCACAO S.A.\",\n\"tomador_servico_email\": \"liviatoledo@pontue.com.br\",\n\"tomador_servico_endereco_logradouro\": \"RUI BARBOSA, 156, ANDAR 1 SALA 6, BELAVISTA\",\n\"tomador_servico_endereco_numero\": \"\",\n\"tomador_servico_endereco_andar\": \"ANDAR 1\",\n\"tomador_servico_endereco_sala\": \"SALA 6\",\n\"tomador_servico_endereco_bairro\": \"-\",\n\"tomador_servico_municipio\": \"SãoPaulo- SP\",\n\"tomador_servico_cep\": \"01326-010\",\n\"intermediario_servico_identificado_nfse\": \"NÃO IDENTIFICADO NA NFS-e\",\n\"servico_prestado_codigo_tributacao_nacional\": \"08.02.01 - Instrução, treinamento, orientação pedagógica e educacion...\",\n\"servico_prestado_codigo_tributacao_municipal\": \"-\",\n\"servico_prestado_local_prestacao\": \"RiodeJaneiro- RJ\",\n\"servico_prestado_pais_prestacao\": \"-\",\n\"servico_prestado_descricao_servico\": \"Correção de redação.\",\n\"tributacao_municipal_tributacao_issqn_operacao_tributavel\": \"-\",\n\"tributacao_municipal_pais_resultado_prestacao_servico\": \"-\",\n\"tributacao_municipal_municipio_incidencia_issqn\": \"RiodeJaneiro- RJ\",\n\"tributacao_municipal_regime_especial_tributacao\": \"Nenhum\",\n\"tributacao_municipal_tipo_imunidade\": \"-\",\n\"tributacao_municipal_suspensao_exigibilidade_issqn\": \"Não\",\n\"tributacao_municipal_numero_processo_suspensao\": \"-\",\n\"tributacao_municipal_beneficio_municipal\": \"-\",\n\"tributacao_municipal_valor_servico\": \"R$894,00\",\n\"tributacao_municipal_desconto_incondicionado\": \"-\",\n\"tributacao_municipal_total_deducoes_reducoes\": \"-\",\n\"tributacao_municipal_calculo_bm\": \"-\",\n\"tributacao_municipal_bc_issqn\": \"-\",\n\"tributacao_municipal_alotacao_aplicada\": \"-\",\n\"tributacao_municipal_retencoes_issqn\": \"Não Retido\",\n\"tributacao_municipal_issqn_apurado\": \"-\",\n\"tributacao_federal_irrf\": \"-\",\n\"tributacao_federal_cp\": \"-\",\n\"tributacao_federal_csll\": \"-\",\n\"tributacao_federal_pis\": \"-\",\n\"tributacao_federal_cofins\": \"-\",\n\"tributacao_federal_retencoes_pis_cofins\": \"-\",\n\"tributacao_federal_total_tributos_federais\": \"-\",\n\"valor_total_nfse_valor_servico\": \"R$894,00\",\n\"valor_total_nfse_desconto_condicionado\": \"R$ 0,00\",\n\"valor_total_nfse_desconto_incondicionado\": \"R$ 0,00\",\n\"valor_total_nfse_issqn_retido\": \"-\",\n\"valor_total_nfse_irrf_cp_csll_retidos\": \"R$ 0,00\",\n\"valor_total_nfse_pis_cofins_retidos\": \"-\",\n\"valor_total_nfse_valor_liquido_nfse\": \"R$894,00\",\n\"totas_aproximados_tributos_federais\": \"-\",\n\"totas_aproximados_tributos_estaduais\": \"-\",\n\"totas_aproximados_tributos_municipais\": \"-\"\n}';

@Injectable()
export class OllamaClient {
  constructor(private readonly httpService: HttpService) {}

  async generate(prompt: string, model: string): Promise<string> {
    try {
      const response = await lastValueFrom(
        this.httpService.post('http://localhost:11434/api/generate', {
          // raw: true,
          model,
          prompt,
          stream: false,
        }),
      );

      return response.data.response;
      // return model === 'nfe-llama3.1' ? llamaMock : qwenMock;
    } catch (error) {
      throw new Error(`Ollama API error: ${error.message}`);
    }
  }
}
